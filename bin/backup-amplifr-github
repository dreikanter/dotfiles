#!/usr/bin/env bash

set -e -x

ARCHIVE_PATH=~/Yandex.Disk.localized/
GITHUB_BACKUP_PATH=~/amplifr-github-backup
CURRENT_DATE=$(date +%Y%m%d-%H%M%S)

function backup() {
  echo "---> $1/$2"

  github-backup \
    --incremental \
    --repository $2 \
    --repositories \
    --token $GITHUB_BACKUP_TOKEN \
    --output-directory $GITHUB_BACKUP_PATH/$1/$2 \
    --starred \
    --followers \
    --following \
    --issues \
    --issue-comments \
    --pulls \
    --pull-comments \
    --pull-commits \
    --pull-details \
    --labels \
    --wikis \
    --gists \
    --private \
    --fork \
    --releases \
    $1

  ARCHIVE_FILE=$ARCHIVE_PATH/$CURRENT_DATE/$CURRENT_DATE-$1-$2.tar.gz
  mkdir -p $ARCHIVE_PATH/$CURRENT_DATE
  tar --verbose -cz -f $ARCHIVE_FILE $GITHUB_BACKUP_PATH/$1/$2
  # rclone copy --verbose=3 --no-traverse $ARCHIVE_FILE amplifr-admin:github-backup/
}

backup evilmartians amplifr
backup evilmartians amplifr-front
backup evilmartians amplifr-logux
backup evilmartians amplifr-static
backup evilmartians amplifr-infrastructure
backup evilmartians logux-server-pro
backup evilmartians kube-amplifr
backup evilmartians amplifr-node

backup amplifr ampgs
backup amplifr amplifr-blog
backup amplifr amplifr-instagram-python
backup amplifr amplifr-php
backup amplifr baseimage
backup amplifr bitly
backup amplifr blog-wordpress
backup amplifr changelog
backup amplifr chef-amplifr
backup amplifr chef-base
backup amplifr docker-nginx
backup amplifr faraday-http-cache
backup amplifr flux
backup amplifr heroku-buildpack-openssl
backup amplifr heroku-buildpack-ruby
backup amplifr infrastructure
backup amplifr instagram-private
backup amplifr instagram-ruby-gem
backup amplifr instagram_private_api
backup amplifr instagram_private_api_extensions
backup amplifr linkedin
backup amplifr lurker
backup amplifr moviepy
backup amplifr og-generator
backup amplifr omniauth-soundcloud
backup amplifr preview
backup amplifr simple-rails-buildpack
backup amplifr suwabara
backup amplifr telegram-bot-ruby
backup amplifr tg-bot
backup amplifr tumblr_client
backup amplifr twitter
backup amplifr twitter-text
backup amplifr wiki
