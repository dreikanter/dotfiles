#!/usr/bin/env ruby

require "yaml"
require "fileutils"

def requires_publication?(file_name)
  data = YAML.safe_load(File.read(file_name))
  data.is_a?(Hash) && data["public"] == true
rescue StandardError => e
  false
end

def copy_public_files(src_dir, dest_dir)
  src_dir = File.expand_path(src_dir)
  dest_dir = File.expand_path(dest_dir)

  Dir.glob("#{src_dir}/**/*.md") do |file|
    if requires_publication?(file)
      relative_path = file.sub(/^#{Regexp.escape(src_dir)}\//, "")
      dest_file = File.join(dest_dir, relative_path)
      FileUtils.mkdir_p(File.dirname(dest_file))
      FileUtils.cp_r(file, dest_file, remove_destination: true)
      puts "Copied #{file} to #{dest_file}"
    end
  end
end

src_dir = ENV["PUBLISH_NOTES_SOURCE_PATH"] || "~/Dropbox/Notes"
dest_dir = ENV["PUBLISH_NOTES_DEST_PATH"] || "~/public_notes"

if src_dir.nil? || dest_dir.nil?
  puts "Please set the PUBLISH_NOTES_SOURCE_PATH and PUBLISH_NOTES_DEST_PATH environment variables."
  exit 1
end

copy_public_files(src_dir, dest_dir)

Dir.chdir(File.expand_path(dest_dir)) do
  system("git add .")
  system("git", "commit", "-m", "Update published files")
  system("git", "push", "origin", "main")
end
