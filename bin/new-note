#!/usr/bin/env ruby

require "fileutils"
require "json"
require "optparse"

NOTES_PATH = ENV["NOTES_PATH"] || File.expand_path("~/Dropbox/Notes")
VISUAL_EDITOR = ENV["NOTES_EDITOR"] || "/opt/homebrew/bin/subl --add"

ID_PATH = File.join(NOTES_PATH, "id.json")

options = { tags: [] }

parser = OptionParser.new do |opts|
  opts.banner = "Usage: new-note [options]"
  opts.separator ""
  opts.separator "Creates a new note with auto-incremented ID and opens it in the editor."
  opts.separator ""
  opts.separator "Options:"

  opts.on("--tag=TAG", "Add a tag (can be used multiple times)") do |tag|
    options[:tags] << tag
  end

  opts.on("--location=LOCATION", "Set location in frontmatter") do |loc|
    options[:location] = loc
  end

  opts.on("--slug=SLUG", "Add slug suffix to filename") do |slug|
    options[:slug] = slug
  end

  opts.on("-h", "--help", "Show this help message") do
    puts opts
    puts ""
    puts "Examples:"
    puts "  new-note"
    puts "  new-note --tag=journal --location=\"Berlin, Germany\" --slug=journal"
    puts "  new-note --tag=idea --tag=project"
    puts ""
    puts "Environment variables:"
    puts "  NOTES_PATH    Notes directory (default: ~/Dropbox/Notes)"
    puts "  NOTES_EDITOR  Editor command (default: /opt/homebrew/bin/subl --add)"
    exit
  end
end

parser.parse!

def new_note_path(time, slug: nil)
  suffix = slug ? "_#{slug}" : ""
  File.join(
    File.join(NOTES_PATH, time.strftime("%Y"), time.strftime("%m")),
    "#{time.strftime("%Y%m%d")}_#{generate_new_id}#{suffix}.md"
  )
end

def generate_new_id
  new_id = last_id.succ
  File.write(ID_PATH, JSON.generate({ last_id: new_id }))
  new_id
end

def last_id
  Integer(JSON.parse(File.read(ID_PATH))["last_id"])
rescue StandardError
  Dir.glob(File.join(NOTES_PATH, "**/*.md")).count
end

def generate_frontmatter(options)
  lines = []
  lines << "tags: [#{options[:tags].join(", ")}]" unless options[:tags].empty?
  lines << "location: #{options[:location]}" if options[:location]
  return "" if lines.empty?

  "---\n#{lines.join("\n")}\n---\n\n"
end

file_name = new_note_path(Time.now, slug: options[:slug])
puts file_name
FileUtils.mkdir_p(File.dirname(file_name))

frontmatter = generate_frontmatter(options)
File.write(file_name, frontmatter) unless frontmatter.empty?

begin
  pid = Process.spawn("#{VISUAL_EDITOR} #{NOTES_PATH} #{file_name}")
  Process.detach(pid)
rescue StandardError => e
  warn "Failed to launch editor (#{VISUAL_EDITOR}): #{e.message}"
end
